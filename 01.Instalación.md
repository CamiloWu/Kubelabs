# 1. Instalación de ambiente de **PRUEBAS**: Microk8s <!-- omit in TOC -->

## 1. ¿Porqué Microk8s?

- Tiene addons, fácil de instalar
- Corre en arquitecturas arm
- Es posible correr en HA, multi nodo
- Fácil de instalar y es liviano
- Para ambientes de desarrollo, QA y Producción de baja carga (bajo cierto riesgo!)

## 2. Pasos de Instalación
> [Documentación Oficial](https://microk8s.io/docs)

### 2.1. Requisitos Mínimos del servidor
~~~~
4GB ram

2 vCores

20 GB almacenamiento

SO Linux
~~~~

### 2.2. Preparación

> En el servidor:
>
> conectar por SSH, ejemplo: ssh lab123.kubelabs.tk


```vim
sudo apt update

sudo iptables -P FORWARD ACCEPT

sudo apt install snapd
```

## 3. Instalación
>[Documentación](https://microk8s.io/)

```vim
sudo snap install microk8s --classic

sudo microk8s status --wait-ready
```
> Resultado:
>
> microk8s (1.23/stable) v1.23.3 from Canonical✓ installed

> Para instalar una versión específica: --channel=1.22/stable
### 3.1. Post-Instalación
[Ver archivo de configuración](./post-install.sh)

#### 3.1.1. Permisos para ejecutar microk8s

```vim
sudo usermod -a -G microk8s kube
newgrp microk8s
```

#### 3.1.2. Instalar addons
```vim
sudo snap install kubectl --classic

sudo microk8s.enable dns dashboard storage ingress helm
```

#### 3.1.3. Habilitar administración remota al cluster
```vim
mkdir .kube

sudo sh -c 'echo "--allow-privileged=true" >> /var/snap/microk8s/current/args/kube-apiserver'

sudo microk8s kubectl config set-cluster microk8s-cluster --server=https://<PUBLIC_IP>:16443 --insecure-skip-tls-verify

sudo systemctl restart snap.microk8s.daemon-apiserver.service
```

#### 3.1.4. Exportar la configuración de .kube/config
```vim
microk8s config > ~/.kube/config

cat ~/.kube/config
```

#### 3.1.5. Comprobar la instalación de MicroK8s

```vim
kubectl get nodes

kubectl describe nodes
```



> Copiar la salida del comando cat

### 3.2. Salir del servidor
```vim
exit
```

### 3.3. Opcional: Conexión vsCode local
> Las llaves SSH debe ser provistas por el Tutor del curso.

- Instalar [vsCode](https://code.visualstudio.com/download)
- En vsCode instalar la Extensión [Remote - SSH](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh)
- Configurar las SSH-KEYS con los permisos mínimos:
	- Linux: chmod 400 $USER
	- Windows: configurar accesos de solo lectura al usuario.
- En la configuración de la extensión Remote - SSH, configurar la conexión con el siguiente formato:

```vim
Host <ip-publica>
  HostName <ip-publica>
  User dockerlab
  IdentityFile <SSH-PATH>
```
- Conectar al Host desde vsCode o Terminal usando SSH:
```vim
ssh kubelabs@<ip-publica> -i <SSH-PATH>
```

### 3.4. Opcional: Instalar el dashboard

**NOTA: Debe estar instalado en el punto anterior el addon dashboard (microk8s enable dashboard)**

> Ejecutar en el servidor

```vim
microk8s.dashboard-proxy
```
Probar en browser. Preferiblemente Firefox!
```vim
https://<ip-publica>:10443
```

Copiar y pegar el token generado en el browser y aceptar los ***warnings*** del browser.
