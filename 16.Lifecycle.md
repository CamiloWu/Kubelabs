# 16. Lifecycle <!-- omit in TOC -->

> [Ver los archivos demo](./kubelabs-files-demo)

## 1. Estrategia de Actualización.
> [Documentación Oficial](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/)

### 1.1. Ejecutar el archivo deploy-lifecycle.yml
>[kubelabs-files-demo/deploy-lifecycle.yml](./kubelabs-files-demo/deploy-lifecycle.yml)
```vim
kubectl apply -f kubelabs-files-demo/deploy-lifecycle.yml
```
Este deploy ejecuta 4 pods en el NodePort 30100. Probar en Browser

### 1.2. Validar la estrategia de Deployment
```vim
kubectl describe deploy deploy-lifecycle
```
Resultado:
```yaml
StrategyType:           RollingUpdate
RollingUpdateStrategy:  25% max unavailable, 25% max surge
```

### 1.3. Actualizar el Deploy
```vim
kubectl set image deployment/deploy-lifecycle color=docker.io/kodekloud/webapp-color:v2
```
> La versión de la imagen se está actualizando a :v2

### 1.4. Comprobar el Rolling-Update
```vim
watch kubectl get pods --selector=app=lifecycle
```
Resultado:
> el ***Status*** de los Pods varia cuando se actualizan.

> El comando ***watch*** actualiza la salida cada 2 segundos. ctl + c para salir
~~~~
NAME                                READY   STATUS              RESTARTS   AGE
deploy-lifecycle-59c74cff7b-rr8nm   1/1     Running             0          3m18s
deploy-lifecycle-59c74cff7b-pvfx4   1/1     Terminating         0          3m17s
deploy-lifecycle-8565869dbf-ngkqk   1/1     Running             0          3s
deploy-lifecycle-8565869dbf-l5txb   1/1     Running             0          3s
deploy-lifecycle-59c74cff7b-hfvg2   1/1     Terminating         0          3m21s
deploy-lifecycle-8565869dbf-wttmg   0/1     ContainerCreating   0          0s
deploy-lifecycle-59c74cff7b-tgvz9   1/1     Terminating         0          3m21s
deploy-lifecycle-8565869dbf-vd6dt   0/1     Pending             0          0s
~~~~

#### 1.4.1. Probar la nueva versión en browser. Puerto 30100

#### 1.4.2. Cambiar la estrategia a ***Recreate***
En el archivo:
>[kubelabs-files-demo/deploy-lifecycle.yml](./kubelabs-files-demo/deploy-lifecycle.yml)

##### 1.4.2.1. Cambiar la línea #9 y eliminar las líneas del RollingUpdate
```vim
strategy:
  type: Recreate
```
##### 1.4.2.2. Ejecutar el archivo y validar cambios
```vim
kubectl apply -f kubelabs-files-demo/deploy-lifecycle.yml
```
```vim
watch kubectl get pods --selector=app=lifecycle
```
Resultado:
> Todos los Pods en ***status**: ***Terminating***

> La aplicación queda fuera unos segundos.

~~~~
NAME                                READY   STATUS        RESTARTS   AGE
deploy-lifecycle-59c74cff7b-4lswz   1/1     Terminating   0          4m59s
deploy-lifecycle-59c74cff7b-f9d26   1/1     Terminating   0          4m59s
deploy-lifecycle-59c74cff7b-2fw9z   1/1     Terminating   0          4m59s
deploy-lifecycle-59c74cff7b-grnm5   1/1     Terminating   0          4m59s
~~~~
> Después de unos segundos los Contenedores se crean y la aplicación levanta de nuevo.


## 2. Variables y argumentos

[Documentación Oficial](https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/)

### 2.1. Agregar la variable (env) al contenedor.
Usar el archivo:
>[kubelabs-files-demo/deploy-lifecycle.yml](./kubelabs-files-demo/deploy-lifecycle.yml)

```yaml
env:
	- name: APP_COLOR
		value: pink
```
> La variable APP_COLOR cambia el ***backgroud-color*** de la página.

### 2.2. Ejecutar el deploy y validar el cambio.
```vim
kubectl describe pods --selector=app=lifecycle
```
Resultado:
```yaml
Environment:
  APP_COLOR:  pink
```
## 3. Config Maps y Secrets

>[Documentación Oficial](https://kubernetes.io/docs/concepts/configuration/configmap/)
### 3.1. Crear un CM usando el archivo y listar.
>[kubelabs-files-demo/configmap-definition.yml](./kubelabs-files-demo/configmap-definition.yml)

```vim
kubectl apply -f kubelabs-files-demo/configmap-definition.yml

kubectl describe cm demo-configmap
```
Resultado:
```yaml
Data
====
APP_COLOR:
----
green
```

### 3.2. Aplicar el CM al Pod
> [kubelabs-files-demo/deploy-configmap.yml](./kubelabs-files-demo/deploy-configmap.yml)

```vim
# Eliminar el ejemplo anterior
kubectl delete deploy deploy-lifecycle

# crear el nuevo pod ligado al CM
kubectl apply -f kubelabs-files-demo/deploy-configmap.yml

# revisar configuración
kubectl describe pods --selector=app=lifecycle
```
> TIP: usar explain para revisar la configuración: kubectl explain pods --recursive | grep envFrom -A3

Resultado:
```yaml
Environment Variables from:
		demo-configmap  ConfigMap  Optional: false
```

### 3.3. Revisar en browser, puerto 30100

### 3.4. Opcional. Crear un CM y montarlo como volumen
> [kubelabs-files-demo/deploy-configmap-nginx.yml](./kubelabs-files-demo/deploy-configmap-nginx.yml)

```vim
# eliminar el deploy anterior
kubectl delete deploy deploy-lifecycle

# crear el nuevo deploy con un volumen y configmap
kubectl apply -f kubelabs-files-demo/deploy-configmap-nginx.yml
```
> Este deploy sobreescribe la configuración de Nginx usando un CM.
## 4. Pruebas de Inicio

